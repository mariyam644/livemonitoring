<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sites Monitoring Portal</title>
  
  <!-- LeafletJS CSS & JS (OpenStreetMap) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
    }

    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #003366;
      color: white;
      padding: 10px 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .navbar-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .hamburger {
      font-size: 22px;
      cursor: pointer;
    }

    .title {
      font-size: 18px;
      font-weight: bold;
    }

    .navbar-right i {
      margin-left: 20px;
      cursor: pointer;
    }

    .breadcrumb {
      padding: 10px 20px;
      background: #e6e6e6;
      font-size: 14px;
    }

    .main-content {
      padding: 20px;
    }

    .stop-alarm {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #ffe0e0;
      color: #b30000;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .map-container {
      width: 100%;
      height: 400px;
      margin-bottom: 30px;
    }

    .device-cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 40px;
    }

    .device-box {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: calc(33% - 20px);
      padding: 15px;
      position: relative;
      transition: background-color 0.5s ease;
    }

    .device-name {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 1000; /* Ensure it's above map */
    }

    .device-mini-map {
      width: 100%;
      height: 150px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .sensor {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      font-size: 14px;
    }

    .sidebar {
      position: fixed;
      top: 60px;
      left: -200px;
      width: 200px;
      height: 100%;
      background-color: #003366;
      color: white;
      padding-top: 20px;
      transition: left 0.3s;
      z-index: 10;
    }

    .sidebar.show {
      left: 0;
    }

    .sidebar a {
      display: block;
      padding: 10px 20px;
      text-decoration: none;
      color: white;
    }

    .sidebar a:hover {
      background-color: #005999;
    }

    .device-list-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .device-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .device-list-header h3 {
      margin: 0;
    }

    .search-filter {
      display: flex;
      gap: 10px;
    }

    .search-filter input,
    .search-filter select {
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      text-align: left;
      padding: 10px;
    }

    th {
      background-color: #f0f0f0;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    /* Leaflet Map Styling */
    .map-container, .device-mini-map {
      background: #f8f8f8;
    }

    .leaflet-container {
      background: #f8f8f8 !important;
      border-radius: 8px;
    }

    .device-mini-map.leaflet-container {
      cursor: default;
    }

    /* Real-time update animations */
    @keyframes highlight {
      0% { background-color: rgba(173, 216, 230, 0.5); }
      100% { background-color: transparent; }
    }

    .updated {
      animation: highlight 1.5s ease;
    }

    /* Status indicator */
    .status-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .status-realtime {
      background-color: #4CAF50;
      color: white;
    }

    .status-polling {
      background-color: #FF9800;
      color: black;
    }

    .status-offline {
      background-color: #F44336;
      color: white;
    }

    @media (max-width: 768px) {
      .device-box {
        width: 100%;
      }
      
      .status-indicator {
        bottom: 10px;
        right: 10px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <div class="navbar">
    <div class="navbar-left">
      <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>
      <div class="title">Sites Monitoring Portal</div>
    </div>
    <div class="navbar-right">
      <i>üîä</i>
      <i>‚ùó</i>
      <i>üë§</i>
    </div>
  </div>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <a href="index.html">üìä Dashboard</a>
    <a href="devices-data.html">üìç Devices</a>
    <a href="alerts.html">üö® Alerts</a>
  </div>

  <!-- Breadcrumb -->
  <div class="breadcrumb">Home > Dashboard</div>

  <!-- Stop Alarm Box -->
  <div class="main-content">
    <div class="stop-alarm">
      <span>üõë Stop Alarm</span>
      <span id="alarm-icon" onclick="toggleAlarm()">üîä</span>
    </div>

    <!-- Main Map (Top) -->
    <div id="mainMap" class="map-container"></div>

    <!-- Device Cards (TD1 to TD6) -->
    <div class="device-cards">
      <div class="device-box">
        <div class="device-name">TD1</div>
        <div class="device-mini-map" id="miniMap1"></div>
        <div class="sensor"><strong>Temperature:</strong> <span class="temp-value">26</span>¬∞C</div>
        <div class="sensor"><strong>Humidity:</strong> <span class="humidity-value">45</span>%</div>
        <div class="sensor"><strong>Wind Speed:</strong> <span class="wind-value">12</span> km/h</div>
        <div class="sensor"><strong>Gas Level:</strong> <span class="gas-value">Safe</span></div>
      </div>
      <div class="device-box">
        <div class="device-name">TD2</div>
        <div class="device-mini-map" id="miniMap2"></div>
        <div class="sensor"><strong>Temperature:</strong> <span class="temp-value">28</span>¬∞C</div>
        <div class="sensor"><strong>Humidity:</strong> <span class="humidity-value">55</span>%</div>
        <div class="sensor"><strong>Wind Speed:</strong> <span class="wind-value">11</span> km/h</div>
        <div class="sensor"><strong>Gas Level:</strong> <span class="gas-value">Alert</span></div>
      </div>
      <div class="device-box">
        <div class="device-name">TD3</div>
        <div class="device-mini-map" id="miniMap3"></div>
        <div class="sensor"><strong>Temperature:</strong> <span class="temp-value">25</span>¬∞C</div>
        <div class="sensor"><strong>Humidity:</strong> <span class="humidity-value">40</span>%</div>
        <div class="sensor"><strong>Wind Speed:</strong> <span class="wind-value">13</span> km/h</div>
        <div class="sensor"><strong>Gas Level:</strong> <span class="gas-value">Moderate</span></div>
      </div>
      <div class="device-box">
        <div class="device-name">TD4</div>
        <div class="device-mini-map" id="miniMap4"></div>
        <div class="sensor"><strong>Temperature:</strong> <span class="temp-value">27</span>¬∞C</div>
        <div class="sensor"><strong>Humidity:</strong> <span class="humidity-value">48</span>%</div>
        <div class="sensor"><strong>Wind Speed:</strong> <span class="wind-value">14</span> km/h</div>
        <div class="sensor"><strong>Gas Level:</strong> <span class="gas-value">Safe</span></div>
      </div>
      <div class="device-box">
        <div class="device-name">TD5</div>
        <div class="device-mini-map" id="miniMap5"></div>
        <div class="sensor"><strong>Temperature:</strong> <span class="temp-value">29</span>¬∞C</div>
        <div class="sensor"><strong>Humidity:</strong> <span class="humidity-value">50</span>%</div>
        <div class="sensor"><strong>Wind Speed:</strong> <span class="wind-value">10</span> km/h</div>
        <div class="sensor"><strong>Gas Level:</strong> <span class="gas-value">High</span></div>
      </div>
      <div class="device-box">
        <div class="device-name">TD6</div>
        <div class="device-mini-map" id="miniMap6"></div>
        <div class="sensor"><strong>Temperature:</strong> <span class="temp-value">30</span>¬∞C</div>
        <div class="sensor"><strong>Humidity:</strong> <span class="humidity-value">60</span>%</div>
        <div class="sensor"><strong>Wind Speed:</strong> <span class="wind-value">15</span> km/h</div>
        <div class="sensor"><strong>Gas Level:</strong> <span class="gas-value">Critical</span></div>
      </div>
    </div>

    <!-- Device List -->
    <div class="device-list-section">
      <div class="device-list-header">
        <h3>Device List</h3>
        <div class="search-filter">
          <input type="text" placeholder="Search" />
          <select>
            <option>All</option>
            <option>Active</option>
            <option>Inactive</option>
          </select>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Device ID</th>
            <th>Name</th>
            <th>Temperature</th>
            <th>Humidity</th>
            <th>Wind Speed</th>
            <th>Gas Detection</th>
          </tr>
        </thead>
        <tbody id="devicesTableBody">
          <!-- Data will be loaded dynamically from API -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Status Indicator -->
  <div id="statusIndicator" class="status-indicator status-realtime">
    Real-time Updates: Active
  </div>

  <script>
    // Global map references
    let mainMap;
    const miniMaps = {};
    let refreshInterval;
    let socket;
    let isWebSocketConnected = false;

    // Initialize Leaflet maps
    function initMaps() {
      try {
        const center = [24.8607, 67.0011];
        
        // Initialize main map
        mainMap = L.map('mainMap').setView(center, 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(mainMap);
        
        // Initialize mini maps
        for (let i = 1; i <= 6; i++) {
          const mapId = `miniMap${i}`;
          miniMaps[mapId] = L.map(mapId).setView(center, 13);
          
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          }).addTo(miniMaps[mapId]);
          
          // Disable interactions on mini maps
          miniMaps[mapId].touchZoom.disable();
          miniMaps[mapId].doubleClickZoom.disable();
          miniMaps[mapId].scrollWheelZoom.disable();
          miniMaps[mapId].boxZoom.disable();
          miniMaps[mapId].keyboard.disable();
          miniMaps[mapId].dragging.disable();
        }
      } catch (error) {
        console.error("Map initialization error:", error);
        document.getElementById("mainMap").innerHTML = 
          '<div style="padding:20px;color:red">Map could not load. Please check your internet connection.</div>';
      }
    }

    // Toggle sidebar visibility
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const hamburger = document.querySelector('.hamburger');
      sidebar.classList.toggle('show');
      hamburger.textContent = sidebar.classList.contains('show') ? '‚úñ' : '‚ò∞';
    }

    // Toggle alarm icon
    function toggleAlarm() {
      const icon = document.getElementById("alarm-icon");
      icon.textContent = icon.textContent === "üîä" ? "üîá" : "üîä";
    }

    // Function to fetch devices data from API
    async function fetchDevices() {
      try {
        console.log("Fetching devices data...");
        const response = await fetch('http://localhost:3000/api/devices');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Full API response:', data);
        
        if (data && data.status === 'success' && data.devices && data.devices.length > 0) {
          updateDeviceCards(data.devices);
          updateDeviceTable(data.devices);
          updateMapMarkers(data.devices);
        } else {
          console.warn('No valid devices data received', data);
        }
      } catch (error) {
        console.error('Error fetching devices:', error);
        document.getElementById("devicesTableBody").innerHTML = `
          <tr>
            <td colspan="6" style="color:red;text-align:center">
              Error loading data. Please check console for details.
            </td>
          </tr>`;
      }
    }

    // Update device cards with real data
    function updateDeviceCards(devices) {
      // Clear existing data first
      document.querySelectorAll('.device-box').forEach(box => {
        box.querySelector('.temp-value').textContent = '--';
        box.querySelector('.humidity-value').textContent = '--';
        box.querySelector('.wind-value').textContent = '--';
        box.querySelector('.gas-value').textContent = '--';
      });

      // Update with new data
      devices.forEach((device, index) => {
        if (index < 6) {
          const box = document.querySelector(`.device-box:nth-child(${index + 1})`);
          
          if (box) {
            // Temperature (check multiple possible field names)
            const temp = device.temperature || device.temp || device.tempC || '--';
            box.querySelector('.temp-value').textContent = temp;
            
            // Humidity
            const humidity = device.humidity || device.humidityValue || '--';
            box.querySelector('.humidity-value').textContent = humidity;
            
            // Wind Speed
            const wind = device.windSpeed || device.wind || device.wind_speed || '--';
            box.querySelector('.wind-value').textContent = wind;
            
            // Gas Level
            const gas = device.gasLevel || device.gas || device.gas_status || 0;
            box.querySelector('.gas-value').textContent = getGasLevelText(gas);
            
            // Update device name if available
            if (device.name) {
              box.querySelector('.device-name').textContent = device.name;
            }
            
            // Add highlight animation
            box.classList.remove('updated');
            void box.offsetWidth; // Trigger reflow
            box.classList.add('updated');
          }
        }
      });
    }

    // Add/update markers on maps
    function updateMapMarkers(devices) {
      // Clear existing markers from main map
      if (mainMap) {
        mainMap.eachLayer(layer => {
          if (layer instanceof L.Marker) {
            mainMap.removeLayer(layer);
          }
        });
      }

      // Clear markers from mini maps and add new ones
      devices.forEach((device, index) => {
        if (index < 6 && device.lat && device.lng) {
          const mapId = `miniMap${index + 1}`;
          const miniMap = miniMaps[mapId];
          
          // Clear existing markers
          if (miniMap) {
            miniMap.eachLayer(layer => {
              if (layer instanceof L.Marker) {
                miniMap.removeLayer(layer);
              }
            });
            
            // Add new marker
            const marker = L.marker([device.lat, device.lng])
              .addTo(miniMap)
              .bindPopup(device.name);
              
            // Add animation effect
            if (marker.getElement()) {
              marker.getElement().classList.add('updated');
              setTimeout(() => {
                if (marker.getElement()) {
                  marker.getElement().classList.remove('updated');
                }
              }, 1500);
            }
          }
          
          // Add marker to main map
          if (mainMap) {
            const mainMarker = L.marker([device.lat, device.lng])
              .addTo(mainMap)
              .bindPopup(`${device.name}<br>Temp: ${device.temperature}¬∞C`);
              
            // Add animation effect
            if (mainMarker.getElement()) {
              mainMarker.getElement().classList.add('updated');
              setTimeout(() => {
                if (mainMarker.getElement()) {
                  mainMarker.getElement().classList.remove('updated');
                }
              }, 1500);
            }
          }
        }
      });
    }

    // Convert gas level number to text
    function getGasLevelText(gasLevel) {
      if (gasLevel === undefined || gasLevel === null) return 'Unknown';
      if (gasLevel === 0) return 'Safe';
      if (gasLevel <= 2) return 'Low';
      if (gasLevel <= 4) return 'Moderate';
      if (gasLevel <= 6) return 'High';
      return 'Critical';
    }

    // Update device table with real data
    function updateDeviceTable(devices) {
      const tableBody = document.getElementById('devicesTableBody');
      tableBody.innerHTML = ''; // Clear existing rows
      
      devices.forEach(device => {
        const row = document.createElement('tr');
        
        // Add device ID to row for highlighting
        row.setAttribute('data-device-id', device.id);
        
        // Temperature (check multiple field names)
        const temp = device.temperature || device.temp || device.tempC || '--';
        
        // Humidity
        const humidity = device.humidity || device.humidityValue || '--';
        
        // Wind Speed
        const wind = device.windSpeed || device.wind || device.wind_speed || '--';
        
        // Gas Level
        const gas = device.gasLevel || device.gas || device.gas_status || 0;
        
        row.innerHTML = `
          <td>${device.id || '--'}</td>
          <td>${device.name || '--'}</td>
          <td>${temp}${typeof temp === 'number' ? '¬∞C' : ''}</td>
          <td>${humidity}${typeof humidity === 'number' ? '%' : ''}</td>
          <td>${wind}${typeof wind === 'number' ? ' km/h' : ''}</td>
          <td>${getGasLevelText(gas)}</td>
        `;
        
        tableBody.appendChild(row);
        
        // Add highlight animation
        row.classList.remove('updated');
        void row.offsetWidth; // Trigger reflow
        row.classList.add('updated');
      });
    }
    
    // Function to initialize WebSocket connection
    function connectWebSocket() {
      try {
        socket = new WebSocket('ws://localhost:8080');
        
        socket.addEventListener('open', (event) => {
          console.log('WebSocket connected!');
          isWebSocketConnected = true;
          updateStatusIndicator('realtime');
          
          // Disable polling since we have real-time updates
          clearInterval(refreshInterval);
        });
        
        socket.addEventListener('message', (event) => {
          const data = JSON.parse(event.data);
          
          if (data.type === 'device-update') {
            console.log('Real-time update received:', data.timestamp);
            updateDeviceCards(data.devices);
            updateDeviceTable(data.devices);
            updateMapMarkers(data.devices);
          }
        });
        
        socket.addEventListener('error', (error) => {
          console.error('WebSocket error:', error);
          isWebSocketConnected = false;
          handleWebSocketFailure();
        });
        
        socket.addEventListener('close', (event) => {
          console.log('WebSocket closed:', event.reason);
          isWebSocketConnected = false;
          handleWebSocketFailure();
        });
      } catch (error) {
        console.error('WebSocket initialization failed:', error);
        handleWebSocketFailure();
      }
    }
    
    // Fallback to polling if WebSocket fails
    function handleWebSocketFailure() {
      console.log('Falling back to polling...');
      updateStatusIndicator('polling');
      
      // Start polling every 10 seconds
      clearInterval(refreshInterval);
      refreshInterval = setInterval(fetchDevices, 10000);
      
      // Try to reconnect WebSocket every 30 seconds
      setInterval(() => {
        if (!isWebSocketConnected) {
          console.log('Attempting WebSocket reconnection...');
          connectWebSocket();
        }
      }, 30000);
    }
    
    // Update the status indicator
    function updateStatusIndicator(status) {
      const indicator = document.getElementById('statusIndicator');
      indicator.className = 'status-indicator'; // Reset classes
      
      switch (status) {
        case 'realtime':
          indicator.classList.add('status-realtime');
          indicator.textContent = 'Real-time Updates: Active';
          break;
        case 'polling':
          indicator.classList.add('status-polling');
          indicator.textContent = 'Polling Updates: Active';
          break;
        case 'offline':
          indicator.classList.add('status-offline');
          indicator.textContent = 'Offline: No Updates';
          break;
      }
    }

    // Initialize everything when page loads
    function initializeApp() {
      initMaps(); // Initialize Leaflet maps
      fetchDevices(); // Load initial data
      connectWebSocket(); // Start WebSocket connection
    }

    // Start the application
    initializeApp();
  </script>
</body>
</html>