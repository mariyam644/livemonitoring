<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Devices Page</title>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
    }

    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #003366;
      color: white;
      padding: 10px 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .navbar-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .hamburger {
      font-size: 22px;
      cursor: pointer;
    }

    .title {
      font-size: 18px;
      font-weight: bold;
    }

    .navbar-right i {
      margin-left: 20px;
      cursor: pointer;
    }

    .breadcrumb {
      padding: 10px 20px;
      background: #e6e6e6;
      font-size: 14px;
    }

    .stop-alarm {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #ffe0e0;
      color: #b30000;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: bold;
      margin: 15px 20px;
    }

    .container {
      padding: 0 20px;
    }

    h2 {
      margin-top: 20px;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }

    th {
      background-color: #f0f0f0;
    }

    .more-options {
      cursor: pointer;
    }

    .rows-info {
      margin-top: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }

    .add-button {
      background-color: #007bff;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      float: right;
      margin-top: 10px;
    }

    .action-icons i {
      margin: 0 5px;
      cursor: pointer;
    }

    .sidebar {
      position: fixed;
      top: 60px;
      left: -200px;
      width: 200px;
      height: 100%;
      background-color: #003366;
      color: white;
      padding-top: 20px;
      transition: left 0.3s;
      z-index: 10;
    }

    .sidebar.show {
      left: 0;
    }

    .sidebar a {
      display: block;
      padding: 10px 20px;
      text-decoration: none;
      color: white;
    }

    .sidebar a:hover {
      background-color: #005999;
    }

    .footer-rows {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }

  </style>
</head>
<body>

  <!-- Navbar -->
  <div class="navbar">
    <div class="navbar-left">
      <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>
      <div class="title">Sites Monitoring Portal</div>
    </div>
    <div class="navbar-right">
      <i>üîä</i>
      <i>‚ùó</i>
      <i>üë§</i>
    </div>
  </div>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <a href="index.html">üìä Dashboard</a>
    <a href="devices-data.html">üìç Devices</a>
    <a href="alerts.html">üö® Alerts</a>
  </div>

  <div class="breadcrumb">Home > Devices</div>

  <div class="stop-alarm">
    <span>üõë Stop Alarm</span>
    <span id="alarm-icon" onclick="toggleAlarm()">üîä</span>
  </div>

  <!-- Map Container -->
  <div id="mainMap" style="width:100%; height:400px; margin:20px 0;"></div>
  
  <div class="container">
    <h2>Devices Data</h2>

    <div class="rows-info">
      <div>Rows per page: 100</div>
      <div>1‚Äì6 of 6 &nbsp;&nbsp; <span>&lt;</span> <span>&gt;</span></div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Device Name</th>
          <th>Temperature <span class="more-options">‚ãÆ</span></th>
          <th>Wind <span class="more-options">‚ãÆ</span></th>
          <th>Humidity <span class="more-options">‚ãÆ</span></th>
          <th>Gas <span class="more-options">‚ãÆ</span></th>
        </tr>
      </thead>
      <tbody id="devicesTableBody">
        <tr><td>TD 5</td><td>0</td><td>20</td><td>45</td><td>false</td></tr>
        <tr><td>DT 6</td><td>0</td><td>0</td><td>0</td><td>false</td></tr>
        <tr><td>TD 2</td><td>0</td><td>0</td><td>0</td><td>false</td></tr>
        <tr><td>TD 4</td><td>0</td><td>0</td><td>0</td><td>false</td></tr>
        <tr><td>asdddddd</td><td>23</td><td>0</td><td>64</td><td>false</td></tr>
        <tr><td>TD 3</td><td>0</td><td>0</td><td>0</td><td>false</td></tr>
      </tbody>
    </table>

    <div class="add-button">+ Add Devices</div>

    <h2>Devices Threshold Data</h2>
    <table>
      <tr>
        <th>Actions</th>
        <th>Device Name</th>
        <th>Temperature Threshold</th>
        <th>Wind Threshold</th>
        <th>Humidity Threshold</th>
        <th>Radius Threshold</th>
      </tr>
      <tr>
        <td class="action-icons">
          <i class="fas fa-save"></i>
          <i class="fas fa-edit"></i>
          <i class="fas fa-trash-alt"></i>
        </td>
        <td>TD 5</td><td>0</td><td>0</td><td>0</td><td>0</td>
      </tr>
      <tr>
        <td class="action-icons">
          <i class="fas fa-save"></i>
          <i class="fas fa-edit"></i>
          <i class="fas fa-trash-alt"></i>
        </td>
        <td>DT 6</td><td>0.20</td><td>0</td><td>0</td><td>0</td>
      </tr>
      <tr>
        <td class="action-icons">
          <i class="fas fa-save"></i>
          <i class="fas fa-edit"></i>
          <i class="fas fa-trash-alt"></i>
        </td>
        <td>TD 2</td><td>0</td><td>0</td><td>0</td><td>0</td>
      </tr>
      <tr>
        <td class="action-icons">
          <i class="fas fa-save"></i>
          <i class="fas fa-edit"></i>
          <i class="fas fa-trash-alt"></i>
        </td>
        <td>TD 4</td><td>0</td><td>0</td><td>0</td><td>0</td>
      </tr>
      <tr>
        <td class="action-icons">
          <i class="fas fa-save"></i>
          <i class="fas fa-edit"></i>
          <i class="fas fa-trash-alt"></i>
        </td>
        <td>asdddddd</td><td>60</td><td>25</td><td>25</td><td>25</td>
      </tr>
      <tr>
        <td class="action-icons">
          <i class="fas fa-save"></i>
          <i class="fas fa-edit"></i>
          <i class="fas fa-trash-alt"></i>
        </td>
        <td>TD 3</td><td>50</td><td>30</td><td>30</td><td>0</td>
      </tr>
    </table>

    <div class="footer-rows">
      <div>Rows per page: 100</div>
      <div>1‚Äì6 of 6 &nbsp;&nbsp; <span>&lt;</span> <span>&gt;</span></div>
    </div>
  </div>

  <script>
  // Map and circle variables
  let map;
  let allowedRadiusCircle;
  
  // Initialize Google Map with radius
  function initMap() {
    const center = { lat: 24.8607, lng: 67.0011 };
    map = new google.maps.Map(document.getElementById("mainMap"), {
      center,
      zoom: 12
    });
    
    // Create radius circle (500 meters)
    allowedRadiusCircle = new google.maps.Circle({
      strokeColor: "#3498db",
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: "#3498db",
      fillOpacity: 0.15,
      map,
      center,
      radius: 500  // Radius in meters
    });
  }

  // Function to check if device is within radius
  function checkDeviceLocation(device) {
    const deviceLocation = new google.maps.LatLng(device.lat, device.lng);
    const center = new google.maps.LatLng(24.8607, 67.0011);
    const distance = google.maps.geometry.spherical.computeDistanceBetween(
      deviceLocation,
      center
    );
    
    if (distance > 500) { // 500 meters
      triggerAlarm(`Device ${device.name} left the allowed radius!`);
      return false;
    }
    return true;
  }

  // Function to trigger alarm
  function triggerAlarm(message) {
    alert(message);
    const icon = document.getElementById("alarm-icon");
    icon.textContent = "üîä";
    icon.style.color = "red";
  }
  
  // Fetch devices from backend
  async function loadDevices() {
    try {
      const response = await fetch('http://localhost:3000/api/devices');
      if (!response.ok) throw new Error('Network error');
      const devices = await response.json();
      
      // Update HTML table
      const tableBody = document.getElementById('devicesTableBody');
      tableBody.innerHTML = devices.map(device => {
        const isWithinRadius = checkDeviceLocation(device);
        return `
        <tr style="${!isWithinRadius ? 'background-color: #ffdddd' : ''}">
          <td>${device.name || 'N/A'}</td>
          <td>${device.temperature || 0}¬∞C</td> 
          <td>${device.wind || 0} km/h</td>
          <td>${device.humidity || 0}%</td>
          <td>${!isWithinRadius ? '‚õî Radius' : (device.gas ? '‚ö†Ô∏è Alert' : '‚úÖ Safe')}</td>
        </tr>
      `).join('');
    } catch (error) {
      console.error("Error:", error);
      alert("Could not load devices");
    }
  }

  // Load data on page start
  window.addEventListener('DOMContentLoaded', () => {
    initMap();
    loadDevices();
    // Check devices regularly every 30 seconds
    setInterval(loadDevices, 30000);
  });

  // Toggle sidebar function
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const hamburger = document.querySelector('.hamburger');
    sidebar.classList.toggle('show');
    hamburger.textContent = sidebar.classList.contains('show') ? '‚úñ' : '‚ò∞';
  }

  // Toggle alarm function
  function toggleAlarm() {
    const icon = document.getElementById("alarm-icon");
    icon.textContent = icon.textContent === "üîä" ? "üîá" : "üîä";
  }
</script>

</body>
</html>
